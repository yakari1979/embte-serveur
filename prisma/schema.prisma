// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- UTILISATEURS ---
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  role          Role      @default(WORKER)
  jobTitle      String?   // Ex: Ma√ßon, Architecte, Comptable
  isSuspended   Boolean   @default(false)
  createdAt     DateTime  @default(now())
  
  // Relations
  // Ajoute cette ligne pour la relation inverse :
  workingOnProjects Project[] @relation("ProjectWorkers")
  managedProjects Project[]     @relation("ProjectManager")
  assignedTasks   Task[]        @relation("AssignedTo")
  reports         DailyReport[] // Les rapports qu'il a √©crits
  logs            ActivityLog[]
  // --- AJOUTE CETTE LIGNE ICI ---
  supplyRequests    SupplyRequest[]
  // --- AJOUTE CETTE LIGNE ICI ---
  connectionLogs    ConnectionLog[] 
  // üëá AJOUT ICI
  inventoryLogs InventoryLog[]
}


model Project {
  id          String        @id @default(uuid())
  code        String?       @unique 
  name        String
  description String?       @db.Text
  status      ProjectStatus @default(PENDING)
  
  // --- 1. INFORMATIONS G√âN√âRALES ---
  projectType String        // R√©sidentiel, Commercial...
  objective   String?       // Habitation, Location, Vente...
  urgency     String?       // Imm√©diat, 3-6 mois...
  
  // --- 2. FONCIER & LOCALISATION ---
  location    String        // Ville / Quartier
  surface     Float?        // m¬≤
  landStatus  String?       // Nu, B√¢ti...
  legalStatus String?       // Titre Foncier, Bail, D√©lib√©ration... (CRUCIAL SN)
  isOwner     Boolean       @default(false)
  
  // --- 3. URBANISME & ACC√àS ---
  zoneType    String?       // Urbaine, Rurale...
  accessType  String?       // Goudron, Piste, Sablonneux...
  utilities   String?       // JSON stringify : ["Eau", "Elec", "Senelec"]
  
  // --- 4. B√ÇTIMENT & TECHNIQUE ---
  buildingType String?      // Villa, R+1, R+4...
  floors       Int?         @default(1)
  units        Int?         @default(1) // Nbr logements
  hasElevator  Boolean      @default(false)
  soilStudy    Boolean      @default(false) // √âtude de sol faite ?
  
  // --- 5. FINITIONS & BUDGET ---
  standing     String?      // Eco, Standard, Haut Standing
  budget       Float        @default(0.0)
  startDate    DateTime?    
  
  // --- 6. CLIENT ---
  clientPhone  String?      // Contact rapide
  contactPref  String?      // Whatsapp, Appel...

  managerId   String?
  manager     User?         @relation("ProjectManager", fields: [managerId], references: [id])
  
  // Liaison Client (via l'ID user qui a cr√©√©)
  clientId    String? 

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tasks       Task[]
  reports     DailyReport[]
  documents   Document[]
  materials   MaterialOrder[]
  // Ajoute cette ligne pour lister les ouvriers du chantier :
  workers     User[]        @relation("ProjectWorkers")
  progress    Int           @default(0) // Pourcentage d'avancement (ex: 45)

  // --- AJOUTE CES DEUX LIGNES ICI ---
  inventory       InventoryItem[]
  supplyRequests  SupplyRequest[]
}

// --- T√ÇCHES & SUIVI ---
model Task {
  id          String     @id @default(uuid())
  title       String
  description String?    @db.Text
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?
  
  projectId   String
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  assignedToId String?
  assignedTo   User?     @relation("AssignedTo", fields: [assignedToId], references: [id])
  
  createdAt   DateTime   @default(now())
}

// --- RAPPORTS JOURNALIERS (Le journal de bord du chantier) ---

model DailyReport {
  id          String       @id @default(uuid())
  content     String       @db.Text
  weather     String?      
  
  // NOUVEAU : Stockage des fichiers (JSON: [{url, type}, ...])
  media       Json?        
  
  // NOUVEAU : Statut de lecture par le manager
  status      ReportStatus @default(PENDING) 

  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  authorId    String
  author      User         @relation(fields: [authorId], references: [id])
  
  createdAt   DateTime     @default(now())
}

// --- GESTION MAT√âRIAUX & DOCUMENTS ---
model MaterialOrder {
  id          String      @id @default(uuid())
  supplier    String
  items       Json        // Liste: [{nom: "Ciment", qte: 50, prix: 5000}]
  totalCost   Float
  status      OrderStatus @default(PENDING)
  deliveryDate DateTime?
  
  projectId   String
  project     Project     @relation(fields: [projectId], references: [id])
}

model Document {
  id        String   @id @default(uuid())
  name      String
  url       String
  type      DocType  @default(OTHER) // PLAN, INVOICE, CONTRACT
  
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  
  createdAt DateTime @default(now())
}

model ActivityLog {
  id        String   @id @default(uuid())
  action    String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  timestamp DateTime @default(now())
}

// ...

model ContactRequest {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  email     String
  phone     String
  
  // Localisation
  location  String?  // Adresse √©crite
  latitude  Float?   // GPS Auto
  longitude Float?   // GPS Auto

  // Cat√©gorisation
  subject   ContactSubject
  message   String   @db.Text
  
  status    ContactStatus @default(NEW)
  createdAt DateTime @default(now())
}

// --- DEMANDES D'APPROVISIONNEMENT ---
model SupplyRequest {
  id          String        @id @default(uuid())
  itemName    String
  quantity    Int
  unit        String
  urgency     Priority      @default(MEDIUM)
  status      RequestStatus @default(PENDING)
  note        String?
  
  projectId   String
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  requesterId String
  requester   User          @relation(fields: [requesterId], references: [id])
  
  createdAt   DateTime      @default(now())
}

// ...

model ConnectionLog {
  id          String   @id @default(uuid())
  
  // Qui ?
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // Quoi ?
  deviceModel String?  // Ex: iPhone 14, Samsung S21
  os          String?  // Ex: iOS, Android, Windows
  browser     String?  // Ex: Chrome, Safari
  
  // Comment ?
  networkType String?  // Ex: wifi, 4g, 3g
  ipAddress   String?  // IP Publique
  
  // O√π ?
  latitude    Float?
  longitude   Float?
  location    String?  // Adresse approximative (si dispo)
  
  // Quand ?
  connectedAt DateTime @default(now())
}


model InventoryItem {
  id              String       @id @default(uuid())
  name            String
  category        String?      // Ex: Gros Oeuvre, Plomberie
  
  // Nouveaux champs Smart Stock
  type            MaterialType @default(CONSUMABLE) 
  initialQuantity Int          @default(0) 
  
  quantity        Int          // Stock actuel
  unit            String       // Ex: Sac, m3
  minThreshold    Int          // Seuil alerte
  
  projectId       String
  project         Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  logs            InventoryLog[] // Historique des mouvements

  updatedAt       DateTime     @updatedAt
}

model InventoryLog {
  id          String   @id @default(uuid())
  action      StockAction // USAGE (Utilisation), LOSS (Perte/Vol), RESTOCK (Ajout), RETURN (Retour outil)
  quantity    Int      // Combien on a pris/ajout√©
  note        String?  // Ex: "Coulage dalle chambre 1"
  
  date        DateTime @default(now())
  
  itemId      String
  item        InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  userId      String   // Qui a fait l'action (Manager)
  user        User     @relation(fields: [userId], references: [id])
}

enum MaterialType {
  CONSUMABLE
  EQUIPMENT
}

enum StockAction {
  USAGE
  LOSS
  RESTOCK
  RETURN
}

enum RequestStatus {
  PENDING
  ORDERED
  DELIVERED
  REJECTED
}

enum ContactSubject {
  RECLAMATION
  RENDEZ_VOUS
  AUTRE
}

enum ContactStatus {
  NEW
  READ
  ARCHIVED
}

// --- ENUMS (Listes de choix) ---
enum Role {
  ADMIN     // DG, Superviseur g√©n√©ral
  MANAGER   // Chef de chantier, Ing√©nieur
  WORKER    // Ouvrier, Technicien
  CLIENT    // Le client final
  SUPPLIER  // Fournisseur
}

enum ProjectStatus {
  PENDING      // En attente de validation
  PLANNED
  IN_PROGRESS
  PAUSED
  COMPLETED
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum OrderStatus {
  PENDING
  APPROVED
  DELIVERED
  CANCELLED
}

enum DocType {
  PLAN
  CONTRACT
  INVOICE
  REPORT
  OTHER
}

// Ajouter le statut dans l'enum existant ou en cr√©er un nouveau
enum ReportStatus {
  PENDING   // Envoy√©, pas encore vu
  REVIEWED  // Vu par le manager
}